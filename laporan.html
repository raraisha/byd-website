<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Penjualan - BYD</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to bottom,#000108,#0a1625,#112b45);
      color:#fff;display:flex;min-height:100vh;
    }
    main{ margin-left:250px;padding:50px;width:100%; }
    .glow{ text-shadow:0 0 6px #00ffff,0 0 12px #009dff; }
    .card{ background:#0E1A2Baa;border:1px solid rgba(0,255,255,.15); }
    table{ width:100%;border-collapse:collapse }
    th,td{ padding:10px;border-bottom:1px solid #1f3b55 }
    th{ color:#00eaff;font-weight:600 }
    tr:hover{ background:#102033 }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <div id="sidebar-container"></div>

  <main>
    <div class="absolute right-10 top-8 flex items-center gap-3">
      <span class="text-sm text-gray-300">Admin BYD</span>
      <img src="image/admin.png" class="w-10 h-10 rounded-full border-2 border-cyan-400/40">
    </div>

    <h1 class="text-3xl font-semibold glow mb-10 mt-16">Laporan Penjualan Mobil</h1>

    <!-- GRAFIK DAN TOTAL -->
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card p-6 rounded-2xl shadow-xl">
        <h2 class="text-xl text-cyan-300 font-semibold mb-3">Grafik Berdasarkan Tanggal</h2>
        <canvas id="chartPenjualan" height="120"></canvas>
      </div>

      <div class="card p-6 rounded-2xl shadow-xl flex flex-col justify-center text-center">
        <h2 class="text-xl text-cyan-300 font-semibold mb-3">Total Mobil Terjual</h2>
        <h1 id="totalPenjualan" class="text-5xl font-bold text-cyan-400 drop-shadow-lg">0</h1>
      </div>
    </div>

    <!-- FILER + EXPORT -->
    <div class="mt-10 flex flex-wrap gap-3">
      <select id="filterNama" class="bg-gray-900 border border-cyan-400/40 px-3 py-2 rounded-lg">
        <option value="">Filter Nama (A-Z)</option>
        ${[...Array(26)].map((_,i)=>String.fromCharCode(65+i)).map(l=>`<option value="${l}">${l}</option>`).join("")}
      </select>
      
      <button onclick="exportPDF()" class="px-4 bg-red-600 rounded-lg">PDF</button>
      <button onclick="exportExcel()" class="px-4 bg-green-600 rounded-lg">Excel</button>
      <button onclick="exportCSV()" class="px-4 bg-blue-600 rounded-lg">CSV</button>
    </div>

    <!-- TABEL -->
    <div class="card mt-6 p-6 rounded-2xl">
      <h2 class="text-xl text-cyan-300 mb-4 font-semibold">Riwayat Transaksi</h2>
      <table id="tableData">
        <thead>
          <tr>
            <th>No</th><th>Nama User</th><th>ID Produk</th><th>DP</th><th>Sisa</th>
            <th>Metode</th><th>Kode</th><th>Tanggal</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

<script>
fetch("sidebar.html").then(r=>r.text()).then(h=>sidebar-container.innerHTML=h);
</script>

<script type="module">
import supabase from "./supabase.js"

const tbody = document.getElementById("tbody")
const filterNama=document.getElementById("filterNama")

let allData=[]

// Ambil data + join ke user
async function loadTable(){
  let {data,error} = await supabase
  .from('transaksi')
  .select(`
    *,
    users:nama!id_user ( nama )
  `)

  if(error) return console.error(error)
  allData=data
  renderTable(allData)
  renderChart(allData)
}

// Render tabel
function renderTable(data){
  tbody.innerHTML=""
  data.forEach((d,i)=>{
    tbody.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${d.users?.nama||"Unknown"}</td>
      <td>${d.id_produk}</td>
      <td>${d.jumlah_dp}</td>
      <td>${d.sisa_pembayaran}</td>
      <td>${d.metode_pembayaran}</td>
      <td>${d.kode_pembayaran}</td>
      <td>${new Date(d.tanggal).toLocaleDateString()}</td>
      <td>${d.status||"-"}</td>
    </tr>`
  })
}

// Filter nama
filterNama.onchange=()=>{
  let l=filterNama.value
  if(!l) return renderTable(allData)
  let res=allData.filter(a=>a.users?.nama?.startsWith(l))
  renderTable(res)
}

// Grafik
function renderChart(data){
  const countByDate={}
  data.forEach(t=>{
    let d=new Date(t.tanggal).toLocaleDateString("id-ID",{day:"2-digit",month:"short"})
    countByDate[d]=(countByDate[d]||0)+1
  })
  let labels=Object.keys(countByDate)
  let values=Object.values(countByDate)
  document.getElementById('totalPenjualan').textContent=values.reduce((a,b)=>a+b,0)

  new Chart(chartPenjualan,{
    type:"line",
    data:{ labels, datasets:[{label:"Penjualan",data:values,borderWidth:3}] },
    options:{plugins:{legend:{labels:{color:"#fff"}}},scales:{y:{ticks:{color:"#fff"}},x:{ticks:{color:"#fff"}}}}
  })
}

loadTable()

// EXPORT PDF
window.exportPDF=()=>{
  const { jsPDF }=window.jspdf
  const doc=new jsPDF()
  doc.text("Laporan Transaksi Penjualan Mobil",10,10)
  doc.autoTable({ html:"#tableData" })
  doc.save("laporan_penjualan.pdf")
}

// EXPORT EXCEL
window.exportExcel=()=>{
  let wb=XLSX.utils.table_to_book(document.getElementById("tableData"))
  XLSX.writeFile(wb,"laporan_penjualan.xlsx")
}

// EXPORT CSV
window.exportCSV=()=>{
  let wb=XLSX.utils.table_to_book(document.getElementById("tableData"))
  XLSX.writeFile(wb,"laporan_penjualan.csv")
}
</script>

</body>
</html>
