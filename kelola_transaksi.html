<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kelola Transaksi - Admin BYD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom, #000108, #0a1625, #112b45);
    }
    .glow-cyan { text-shadow: 0 0 20px rgba(0, 217, 255, 0.5); }
    .glow-cyan-sm { text-shadow: 0 0 10px rgba(0, 217, 255, 0.5); }
    .glass-effect {
      background: rgba(10, 22, 40, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 217, 255, 0.2);
    }
    .expand-btn { transition: transform 0.3s ease; }
    .expand-btn:hover { transform: scale(1.1); }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
    ::-webkit-scrollbar-thumb { background: rgba(0, 217, 255, 0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0, 217, 255, 0.5); }
  </style>
</head>
<body class="text-white">
  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <main class="ml-[250px] p-12 min-h-screen">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header Card -->
      <div class="glass-effect rounded-2xl p-8 mb-8 shadow-2xl">
        <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
          <div>
            <h1 class="text-5xl font-bold text-cyan-400 glow-cyan mb-2">âš¡ Kelola Transaksi</h1>
            <p class="text-cyan-400/70 text-lg">Manage semua transaksi penjualan mobil BYD</p>
          </div>
          <button onclick="exportToCSV()" class="bg-gradient-to-r from-cyan-400 to-blue-500 text-gray-900 px-6 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg shadow-cyan-500/50 hover:shadow-cyan-500/70 hover:-translate-y-1 transition-all duration-300">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Export CSV
          </button>
        </div>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div class="relative">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-400/50">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" id="searchInput" placeholder="Cari kode pembayaran, customer, email, atau mobil..." class="w-full pl-12 pr-4 py-3 bg-cyan-400/5 border border-cyan-400/30 rounded-lg text-cyan-400 placeholder-cyan-400/50 focus:outline-none focus:border-cyan-400 focus:bg-cyan-400/10 focus:shadow-lg focus:shadow-cyan-500/20 transition-all duration-300">
          </div>
          <div class="relative">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-400/50">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
            <select id="statusFilter" class="w-full pl-12 pr-4 py-3 bg-cyan-400/5 border border-cyan-400/30 rounded-lg text-cyan-400 focus:outline-none focus:border-cyan-400 focus:bg-cyan-400/10 focus:shadow-lg focus:shadow-cyan-500/20 transition-all duration-300 appearance-none cursor-pointer">
              <option value="all">Semua Status</option>
              <option value="pending">Pending</option>
              <option value="authorize">Authorized</option>
              <option value="settlement">Settlement</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="completed">Completed</option>
              <option value="cancel">Cancelled</option>
              <option value="expire">Expired</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8">
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-cyan-500/20 hover:-translate-y-2 transition-all duration-300">
          <p class="text-cyan-400/70 text-sm mb-2">Total Transaksi</p>
          <p class="text-5xl font-bold text-cyan-400 glow-cyan-sm" id="totalTransactions">0</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-yellow-500/20 hover:-translate-y-2 transition-all duration-300">
          <p class="text-cyan-400/70 text-sm mb-2">Pending</p>
          <p class="text-5xl font-bold text-yellow-400" id="pendingCount">0</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-purple-500/20 hover:-translate-y-2 transition-all duration-300">
          <p class="text-cyan-400/70 text-sm mb-2">Processing</p>
          <p class="text-5xl font-bold text-purple-400" id="processingCount">0</p>
        </div>
        <div class="glass-effect rounded-2xl p-6 shadow-xl hover:shadow-green-500/20 hover:-translate-y-2 transition-all duration-300">
          <p class="text-cyan-400/70 text-sm mb-2">Completed</p>
          <p class="text-5xl font-bold text-green-400" id="completedCount">0</p>
        </div>
      </div>

      <!-- Table -->
      <div class="glass-effect rounded-2xl overflow-hidden shadow-2xl">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-cyan-400/10">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Kode</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Tanggal</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Customer</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Mobil</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Status</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Total</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider border-b-2 border-cyan-400/30">Aksi</th>
              </tr>
            </thead>
            <tbody id="transactionTable">
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </main>

  <!-- Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center p-5">
    <div class="glass-effect rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl shadow-cyan-500/30">
      <div class="p-6 border-b border-cyan-400/20">
        <h2 class="text-3xl font-bold text-cyan-400 glow-cyan">Detail Transaksi</h2>
      </div>
      <div class="p-6" id="detailModalBody"></div>
      <div class="p-6 border-t border-cyan-400/20 flex justify-end">
        <button onclick="closeModal('detailModal')" class="px-6 py-3 bg-cyan-400/10 text-cyan-400 border border-cyan-400/30 rounded-lg hover:bg-cyan-400/20 hover:border-cyan-400 transition-all duration-300 font-semibold">
          Tutup
        </button>
      </div>
    </div>
  </div>

  <!-- Update Status Modal -->
  <div id="updateModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center p-5">
    <div class="glass-effect rounded-2xl max-w-lg w-full shadow-2xl shadow-cyan-500/30">
      <div class="p-6 border-b border-cyan-400/20">
        <h2 class="text-3xl font-bold text-cyan-400 glow-cyan">Update Status Transaksi</h2>
      </div>
      <div class="p-6 space-y-5">
        <div>
          <label class="block text-cyan-400/80 mb-2 font-medium">Status Saat Ini</label>
          <div id="currentStatusBadge"></div>
        </div>
        <div>
          <label class="block text-cyan-400/80 mb-2 font-medium">Status Baru</label>
          <select id="newStatus" class="w-full px-4 py-3 bg-cyan-400/5 border border-cyan-400/30 rounded-lg text-cyan-400 focus:outline-none focus:border-cyan-400 focus:bg-cyan-400/10 transition-all duration-300">
            <option value="">-- Pilih Status --</option>
          </select>
        </div>
        <div>
          <label class="block text-cyan-400/80 mb-2 font-medium">Catatan Admin (Opsional)</label>
          <textarea id="adminNote" placeholder="Tambahkan catatan untuk transaksi ini..." rows="4" class="w-full px-4 py-3 bg-cyan-400/5 border border-cyan-400/30 rounded-lg text-cyan-400 placeholder-cyan-400/50 focus:outline-none focus:border-cyan-400 focus:bg-cyan-400/10 transition-all duration-300 resize-none"></textarea>
        </div>
      </div>
      <div class="p-6 border-t border-cyan-400/20 flex justify-end gap-3">
        <button onclick="closeModal('updateModal')" class="px-6 py-3 bg-cyan-400/10 text-cyan-400 border border-cyan-400/30 rounded-lg hover:bg-cyan-400/20 hover:border-cyan-400 transition-all duration-300 font-semibold">
          Batal
        </button>
        <button onclick="updateTransactionStatus()" class="px-6 py-3 bg-gradient-to-r from-cyan-400 to-blue-500 text-gray-900 rounded-lg font-semibold shadow-lg shadow-cyan-500/50 hover:shadow-cyan-500/70 hover:-translate-y-1 transition-all duration-300">
          Update Status
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import supabase from './supabase.js'

    // Load Sidebar
    fetch('sidebar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('sidebar-container').innerHTML = html;
      })
      .catch(err => console.error('Gagal memuat sidebar:', err));

    // State
    let transactions = [];
    let filteredTransactions = [];
    let selectedTransaction = null;
    let expandedRows = new Set();

    // Status flow mapping
    const statusFlow = {
      pending: ['authorize', 'cancel', 'expire'],
      authorize: ['settlement', 'deny', 'cancel'],
      settlement: ['processing', 'refund'],
      processing: ['shipped', 'cancel'],
      shipped: ['completed'],
      completed: [],
      cancel: [],
      expire: [],
      deny: []
    };

    // Generate mock data (replace with API call)
    async function loadTransactions() {
      const { data, error } = await supabase
        .from('transaksi')
        .select(`
          *,
          user:users!transaksi_id_user_fkey(name, email, no_telp, address),
          mobil:mobil!transaksi_id_produk_fkey(nama_produk, varian, harga)
        `)
        .order('tanggal', { ascending: false });

      if (error) {
        console.error("Supabase error:", error);
        return [];
      }

      return data;
    }

    // Initialize
    async function init() {
      transactions = await loadTransactions();
      filteredTransactions = [...transactions];

      updateStats();
      renderTable();

      document.getElementById('searchInput').addEventListener('input', filterTransactions);
      document.getElementById('statusFilter').addEventListener('change', filterTransactions);
    }

    // Update statistics
    function updateStats() {
      document.getElementById('totalTransactions').textContent = transactions.length;
      document.getElementById('pendingCount').textContent = transactions.filter(t => t.status === 'pending').length;
      document.getElementById('processingCount').textContent = transactions.filter(t => 
        ['settlement', 'processing', 'shipped'].includes(t.status)
      ).length;
      document.getElementById('completedCount').textContent = transactions.filter(t => t.status === 'completed').length;
    }

    // Filter transactions
    function filterTransactions() {
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      filteredTransactions = transactions.filter(t => {
        const matchesSearch = !searchQuery || 
          t.kode_pembayaran.toLowerCase().includes(searchQuery) ||
          t.user.name.toLowerCase().includes(searchQuery) ||
          t.user.email.toLowerCase().includes(searchQuery) ||
          t.mobil.nama_produk.toLowerCase().includes(searchQuery);

        const matchesStatus = statusFilter === 'all' || t.status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      renderTable();
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }

    // Format date
    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Get status badge HTML
    function getStatusBadge(status) {
      const statusConfig = {
        pending: { bg: 'bg-yellow-400/20', text: 'text-yellow-400', border: 'border-yellow-400/50', label: 'Pending' },
        authorize: { bg: 'bg-blue-400/20', text: 'text-blue-400', border: 'border-blue-400/50', label: 'Authorized' },
        settlement: { bg: 'bg-green-400/20', text: 'text-green-400', border: 'border-green-400/50', label: 'Settlement' },
        processing: { bg: 'bg-purple-400/20', text: 'text-purple-400', border: 'border-purple-400/50', label: 'Processing' },
        shipped: { bg: 'bg-indigo-400/20', text: 'text-indigo-400', border: 'border-indigo-400/50', label: 'Shipped' },
        completed: { bg: 'bg-cyan-400/20', text: 'text-cyan-400', border: 'border-cyan-400/50', label: 'Completed' },
        cancel: { bg: 'bg-red-400/20', text: 'text-red-400', border: 'border-red-400/50', label: 'Cancelled' },
        expire: { bg: 'bg-gray-400/20', text: 'text-gray-400', border: 'border-gray-400/50', label: 'Expired' },
        deny: { bg: 'bg-red-400/20', text: 'text-red-400', border: 'border-red-400/50', label: 'Denied' },
        refund: { bg: 'bg-orange-400/20', text: 'text-orange-400', border: 'border-orange-400/50', label: 'Refunded' }
      };

      const config = statusConfig[status] || statusConfig.pending;
      return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold ${config.bg} ${config.text} border ${config.border}">${config.label}</span>`;
    }

    // Toggle expand row
    function toggleExpandRow(id) {
      if (expandedRows.has(id)) {
        expandedRows.delete(id);
      } else {
        expandedRows.add(id);
      }
      renderTable();
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('transactionTable');
      
      if (filteredTransactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-16 text-cyan-400/50 text-lg">Tidak ada transaksi ditemukan</td></tr>';
        return;
      }

      let html = '';
      filteredTransactions.forEach(t => {
        const isExpanded = expandedRows.has(t.id_transaksi);
        
        html += `
          <tr class="border-b border-cyan-400/10 hover:bg-cyan-400/5 transition-colors duration-200">
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <button onclick="toggleExpandRow(${t.id_transaksi})" class="expand-btn text-cyan-400/60 hover:text-cyan-400 transition-colors">
                  ${isExpanded ? 
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4"><path d="m18 15-6-6-6 6"/></svg>' :
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4"><path d="m6 9 6 6 6-6"/></svg>'
                  }
                </button>
                <span class="text-cyan-400/80 font-medium">${t.kode_pembayaran}</span>
              </div>
            </td>
            <td class="px-6 py-4 text-cyan-400/70">${formatDate(t.tanggal)}</td>
            <td class="px-6 py-4">
              <div class="font-semibold text-cyan-400">${t.user.name}</div>
              <div class="text-sm text-cyan-400/60">${t.user.email}</div>
            </td>
            <td class="px-6 py-4 text-cyan-400/80">${t.mobil.nama_produk}</td>
            <td class="px-6 py-4">${getStatusBadge(t.status)}</td>
            <td class="px-6 py-4">
              <div class="font-semibold text-cyan-400">${formatCurrency(t.mobil.harga)}</div>
              ${t.jumlah_dp ? `<div class="text-sm text-cyan-400/60">DP: ${formatCurrency(t.jumlah_dp)}</div>` : ''}
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                <button onclick="showDetail(${t.id_transaksi})" title="Detail" class="p-2 bg-cyan-400/10 border border-cyan-400/30 rounded-lg hover:bg-cyan-400/20 hover:border-cyan-400 hover:scale-110 transition-all duration-300">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-cyan-400">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
                <button onclick="showUpdateModal(${t.id_transaksi})" title="Update" class="p-2 bg-cyan-400/10 border border-cyan-400/30 rounded-lg hover:bg-cyan-400/20 hover:border-cyan-400 hover:scale-110 transition-all duration-300">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-cyan-400">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;

        if (isExpanded) {
          html += `
            <tr class="bg-cyan-400/5 border-b border-cyan-400/10">
              <td colspan="7" class="px-6 py-5">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <div class="text-cyan-400/60 text-sm mb-1">Metode Pembayaran</div>
                    <div class="font-semibold text-cyan-400 capitalize">${(t.metode_pembayaran ?? "-").replace('_', ' ')}</div>
                  </div>
                  <div>
                    <div class="text-cyan-400/60 text-sm mb-1">No. Telepon</div>
                    <div class="font-semibold text-cyan-400">${t.user.no_telp}</div>
                  </div>
                  <div>
                    <div class="text-cyan-400/60 text-sm mb-1">Sisa Pembayaran</div>
                    <div class="font-semibold text-cyan-400">${formatCurrency(t.sisa_pembayaran || 0)}</div>
                  </div>
                  <div>
                    <div class="text-cyan-400/60 text-sm mb-1">Catatan</div>
                    <div class="font-semibold text-cyan-400">${t.catatan || '-'}</div>
                  </div>
                </div>
              </td>
            </tr>
          `;
        }
      });

      tbody.innerHTML = html;
    }

    // Show detail modal
    function showDetail(id) {
      selectedTransaction = transactions.find(t => t.id_transaksi === id);
      if (!selectedTransaction) return;

      const modalBody = document.getElementById('detailModalBody');
      modalBody.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400/60 text-sm mb-1">Alamat</div>
            <div class="text-cyan-400 font-semibold text-lg">${selectedTransaction.user.address}</div>
          </div>
        </div>

        <h3 class="text-xl font-semibold text-cyan-400 mb-4 pb-2 border-b border-cyan-400/20">Informasi Mobil</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400/60 text-sm mb-1">Nama Produk</div>
            <div class="text-cyan-400 font-semibold text-lg">${selectedTransaction.mobil.nama_produk}</div>
          </div>
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400/60 text-sm mb-1">Varian</div>
            <div class="text-cyan-400 font-semibold text-lg">${selectedTransaction.mobil.varian}</div>
          </div>
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400/60 text-sm mb-1">Harga</div>
            <div class="text-cyan-400 font-semibold text-lg">${formatCurrency(selectedTransaction.mobil.harga)}</div>
          </div>
        </div>

        <h3 class="text-xl font-semibold text-cyan-400 mb-4 pb-2 border-b border-cyan-400/20">Informasi Pembayaran</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400/60 text-sm mb-1">Jumlah DP</div>
            <div class="text-cyan-400 font-semibold text-lg">${selectedTransaction.jumlah_dp ? formatCurrency(selectedTransaction.jumlah_dp) : 'Full Payment'}</div>
          </div>
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400/60 text-sm mb-1">Sisa Pembayaran</div>
            <div class="text-cyan-400 font-semibold text-lg">${formatCurrency(selectedTransaction.sisa_pembayaran || 0)}</div>
          </div>
        </div>

        ${selectedTransaction.catatan ? `
          <h3 class="text-xl font-semibold text-cyan-400 mb-4 pb-2 border-b border-cyan-400/20">Catatan</h3>
          <div class="bg-cyan-400/5 p-4 rounded-lg border border-cyan-400/20">
            <div class="text-cyan-400 font-medium">${selectedTransaction.catatan}</div>
          </div>
        ` : ''}
      `;

      openModal('detailModal');
    }

    // Show update modal
    function showUpdateModal(id) {
      selectedTransaction = transactions.find(t => t.id_transaksi === id);
      if (!selectedTransaction) return;

      document.getElementById('currentStatusBadge').innerHTML = getStatusBadge(selectedTransaction.status);
      
      const newStatusSelect = document.getElementById('newStatus');
      const nextStatuses = statusFlow[selectedTransaction.status] || [];
      
      let options = '<option value="">-- Pilih Status --</option>';
      nextStatuses.forEach(status => {
        const statusLabels = {
          authorize: 'Authorized',
          settlement: 'Settlement',
          processing: 'Processing',
          shipped: 'Shipped',
          completed: 'Completed',
          cancel: 'Cancelled',
          expire: 'Expired',
          deny: 'Denied',
          refund: 'Refunded'
        };
        options += `<option value="${status}">${statusLabels[status] || status}</option>`;
      });
      
      newStatusSelect.innerHTML = options;
      document.getElementById('adminNote').value = '';

      openModal('updateModal');
    }

    // Update transaction status
    async function updateTransactionStatus() {
      const newStatus = document.getElementById('newStatus').value;
      const adminNote = document.getElementById('adminNote').value;

      if (!newStatus) {
        alert('Pilih status baru terlebih dahulu');
        return;
      }

      // ðŸ”¥ Update ke database Supabase
      const { data, error } = await supabase
        .from("transaksi")
        .update({
          status: newStatus,
          catatan: adminNote || null,
          updated_at: new Date().toISOString()
        })
        .eq("id_transaksi", selectedTransaction.id_transaksi);

      if (error) {
        console.error("Update Error:", error);
        alert("Gagal mengupdate transaksi! Lihat console.");
        return;
      }

      // ðŸŸ¦ Update array lokal
      transactions = transactions.map(t =>
        t.id_transaksi === selectedTransaction.id_transaksi
          ? { ...t, status: newStatus, catatan: adminNote || t.catatan }
          : t
      );

      // Refresh tampilan
      filterTransactions();
      updateStats();
      renderTable();

      closeModal('updateModal');
      alert('Status berhasil diperbarui!');
    }


    // Export to CSV
    function exportToCSV() {
      const headers = ['ID', 'Kode Pembayaran', 'Tanggal', 'Customer', 'Email', 'Mobil', 'Status', 'Metode', 'DP', 'Sisa'];
      const rows = filteredTransactions.map(t => [
        t.id_transaksi,
        t.kode_pembayaran,
        formatDate(t.tanggal),
        t.user.name,
        t.user.email,
        t.mobil.nama_produk,
        t.status,
        t.metode_pembayaran,
        t.jumlah_dp || 0,
        t.sisa_pembayaran || 0
      ]);

      const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `transaksi_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Modal functions
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      selectedTransaction = null;
    }

    // Close modal on outside click
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal('detailModal');
      }
    });

    document.getElementById('updateModal').addEventListener('click', (e) => {
      if (e.target.id === 'updateModal') {
        closeModal('updateModal');
      }
    });

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', init);
  
    // Expose functions to global scope (fix for onclick in HTML)
    window.toggleExpandRow = toggleExpandRow;
    window.showDetail = showDetail;
    window.showUpdateModal = showUpdateModal;
    window.updateTransactionStatus = updateTransactionStatus;
    window.exportToCSV = exportToCSV;
    window.closeModal = closeModal;
    window.updateTransactionStatus = updateTransactionStatus;
    
  </script>

</body>
</html>